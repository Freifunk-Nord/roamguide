#!/bin/sh

. /lib/functions.sh

wifi_kick(){
  local dev="$1" ; shift
  local mac="$1" ; shift
  local bantime="$1" ; shift
  ubus call hostapd.${dev} del_client '{ "addr" : "'${mac}'", "reason" : "assoc toomany", "ban_time" : '${bantime}' }'
}

count_get(){
  local mac="$1"
  if [ -e /tmp/client-${mac} ] ; then
    touch /tmp/client-${mac}
    cat /tmp/client-${mac}
  else
     echo 0
  fi
}

count_inc(){
  local mac="$1"
  local count=$(count_get "${mac}")
  count=$(expr $count + 1)
  echo $count > /tmp/client-${mac}
}

count_dec(){
  local mac="$1"
  local count=$(count_get "${mac}")
  count=$(expr $count - 1)
  if [ $count -le 0 ] ; then
    count_rm "${mac}"
  else 
    echo $count > /tmp/client-${mac}
  fi
}

count_rm(){
  local mac="$1"
  if [ -e /tmp/client-${mac} ] ; then
    logger -t roamguide "forget ${mac}"
    rm /tmp/client-${mac}
  fi
}

count_cleanup() {
  local now=$(date +%s)
  for file in $(find /tmp -maxdepth 1 -name "client-*"); do
    filedate=$(date +%s -r $file)
    [ $(expr $now - ${filedate}) -gt 120 ] && rm $file
  done
}

client_macs() {
  local dev="$1"
  iw dev "${dev}" station dump | grep Station | sed -e 's/^[^ ]\+ \([0-9a-z:]*\) .*/\1/' 
}

client_tq() {
  local dev="$1"
  local mac="$2"
  iw dev "${dev}" station get "${mac}" | grep "signal avg" | xargs | cut -d' ' -f 3
}

roamguide() {
  local s="$1"
  config_get_bool enabled "$s" 'enabled' 0
  [ $enabled -ne 0 ] || return 0

  config_get device "$s" device
  config_get bantime_base "$s" bantime_base 500
  config_get bantime_factor "$s" bantime_factor 2300

  for mac in $(client_macs "${device}") ; do
    tq=$(client_tq "${device}" "${mac}")
    level=1
    config_list_foreach "$s" signal roamlevel "${tq}" "${device}" "${mac}"
  done
}

roamlevel(){
  local roam_tq="$1" ; shift
  local tq="$1" ; shift
  local device="$1" ; shift
  local mac="$1" ; shift
  if [ ${tq} -le ${roam_tq} ]; then
    mac_count=$(count_get "${device}" "${mac}")
    if [ $mac_count -lt $level ] ; then
      count_inc ${mac}
      local bantime=$(expr $bantime_base + $(expr $mac_count \* $mac_count) \* $bantime_factor)
      logger -t roamguide "${dev}: ban ${mac} ${tq}dBm for ${bantime}ms"
      wifi_kick "${device}" "${mac}" "${bantime}"
      break
    fi 
  fi
  level=$(expr $level + 1)
}

config_load 'roamguide'
config_foreach roamguide 'roamguide'
count_cleanup
